#!/usr/bin/env bash
exec_prefix=@prefix@
libdir=@libdir@
pkglibdir=$libdir/@PACKAGE@

# Find all location of a `.so`
whichlib() {
  # Output of ldconfig:
  #/usr/lib32:
  #       libstdc++.so.6 -> libstdc++.so.6.0.26
  # After the awk:
  # -> /usr/lib32/libstdc++.so.6

  # In OpenSUSE ldconfig, is in '/sbin'.
  PATH=$PATH:/sbin ldconfig -vNX $(echo $LD_LIBRARY_PATH | sed 's/:/ /g') 2>/dev/null |
  awk -v p=$1 'match($1, ":")                    { header=substr($1, 1, length($1)-1)} \
               match($1, "^lib") && match($1, p) { print header "/" $1}'
}

trace() {
    quiet="--quiet"
    lttng-sessiond --daemonize $quiet
    lttng $quiet create thapi-opencl-session
    #Using blocking more to trace event record loss
    lttng $quiet enable-channel --userspace --blocking-timeout=inf blocking-channel     

    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl:*  
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_build:infos*
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_profiling:*
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_arguments:kernel_info
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_devices:device_name

    lttng $quiet add-context --userspace --channel=blocking-channel -t vpid -t vtid

    if [ -z "$LTTNG_UST_OPENCL_LIBOPENCL" ]
    then
      export LTTNG_UST_OPENCL_LIBOPENCL=$(whichlib libOpenCL.so | head -n 1)
    fi
    #Preventing trace event record loss
    export LTTNG_UST_ALLOW_BLOCKING=1
    export LD_PRELOAD=$libdir/libTracerOpenCL.so:$LD_PRELOAD
    export LD_LIBRARY_PATH=$pkglibdir/opencl:$LD_LIBRARY_PATH

    lttng $quiet start
    trap 'trace_epilogue' EXIT SIGABRT SIGSEGV
    "$@"
}

trace_epilogue() {
  lttng $quiet stop
  lttng $quiet destroy
  summary
}

summary() {
    if [ -z "$path" ]; then
        lltng_last_session=$(ls -dt $HOME/lttng-traces/thapi-opencl-session* | head -1)
        echo "Trace location " $lltng_last_session
        echo
    else
        lltng_last_session=$path
    fi
    babeltrace2 --plugin-path=$libdir --component=sink.clprof.dispatch  --params="display=$display" ${lltng_last_session}
}

#  _
# |_) _. ._ _ o ._   _     /\  ._ _
# |  (_| | _> | | | (_|   /--\ | (_| \/
#                    _|           _|
display="compact"
while (( "$#" )); do
    case "$1" in
        -e | --extented) shift; display="extended"   ;;
        -r | --replay)   shift; path=$@; replay=true ;;
        -- )             shift; break ;;
        *)               break  ;;
    esac
done

if [ -z "$replay" ]; then
    trace "$@"
fi

summary $path
