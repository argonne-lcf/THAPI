#!/usr/bin/env bash
exec_prefix=@prefix@
libdir=@libdir@
bindir=@bindir@
pkglibdir=$libdir/@PACKAGE@
prefix=@prefix@
datarootdir=@datarootdir@
datadir=@datadir@

<%def print_loader_logic (language, library, libtracer)
env_var="LTTNG_UST_#{language.upcase}_#{library.upcase}"
directory=language.downcase
<<EOF
    if [ -z "$#{env_var}" ]
    then
      #{env_var}=$(whichlib64_head #{library}.so)
      if [ -n "$#{env_var}" ]
      then
        export #{env_var}="$#{env_var}"
        export LD_LIBRARY_PATH=$pkglibdir/#{directory}:$LD_LIBRARY_PATH
      fi
    else
      export LD_LIBRARY_PATH=$pkglibdir/#{directory}:$LD_LIBRARY_PATH
    fi
    export LD_PRELOAD=$libdir/#{libtracer}.so:$LD_PRELOAD
EOF
end%>

<%# https://www.gnu.org/software/libc/manual/html_node/Argument-Syntax.html
Option names are typically one to three words long, with hyphens to separate words %>

display_help() {
<% if ["omp","ze","cuda","cl", "hip"].all? { |l| languages.include?(l) } %>
    echo "$(basename $0): a tracer / summarizer of OpenCL, L0, CUDA, and HIP driver calls"
<% elsif languages.include?("omp") %>
    echo "$(basename $0): a tracer / summarizer of OMP calls"
<% elsif languages.include?("cl") %>
    echo "$(basename $0): a tracer / summarizer of OpenCL calls"
<% elsif languages.include?("ze") %>
    echo "$(basename $0): a tracer / summarizer of L0 calls"
<% elsif languages.include?("cuda") %>
    echo "$(basename $0): a tracer / summarizer of CUDA calls"
<% elsif languages.include?("hip") %>
    echo "$(basename $0): a tracer / summarizer of HIP calls"
<% end %>
    echo "Usage:"
    echo " $(basename $0) -h | --help "
    echo " $(basename $0) [option]... <application> <application-arguments>"
    echo " $(basename $0) [option]... -r [<trace>]..."
    echo
    echo "  -h, --help                Show this screen"
    echo "  -k, --kernel-verbose      Report kernels execution time with SIMD width and global/local sizes"
    echo "  -e, --extended            Print information for each Hostname / Process / Thread / Device"
    echo "  -t, --trace               Display trace"
    echo "  -l, --timeline            Dump the timeline"
    echo "  -j, --json                Summary will be printed as json"
    echo "  -m, --mode <mode>         [minimal, default, full]"
    echo "  --asm                     Dump in your current directory low level kernels informations (asm, isa, visa, ...)."
    echo "  --mangle                  Use mangled name"
    echo "  --metadata                Display metadata"
    echo "  --max-name-size <size>    Maximun size allowed for kernels names (default 80)"
    echo "  --traced-ranks <rank,...> Comma list separated of MPI rank to trace (default 0). You can use -1 to trace all ranks"
    echo "  -v, --version             Print the version string"
    echo "  -r, --replay    [path]    <application> <application-arguments> will be traited as pathes to traces folders ($HOME/lttng-traces/...)"
    echo "                            If no arguments are provided, will use the latest trace available"
    echo
    echo " Example:"
    echo " $(basename $0) ./a.out"
    echo
    echo "$(basename $0) will save the trace in $HOME/lttng-traces/"
    echo " Please tidy up from time to time"
    echo "                                                   __ "
    echo "For complain, praise, or bug reports please use: <(o )___"
    echo "   https://github.com/argonne-lcf/THAPI           ( ._> /"
    echo "   or send email to {apl,bvideau}@anl.gov          \`---'"
    exit 1
}

display_version() {
    cat $datadir/version
    exit 1
}

# Find all location of a `.so`
whichlib() {
    # Output of ldconfig:
    #/usr/lib32:
    #       libstdc++.so.6 -> libstdc++.so.6.0.26
    # After the awk:
    # -> /usr/lib32/libstdc++.so.6

    # In OpenSUSE ldconfig, is in '/sbin'.
    PATH=$PATH:/sbin ldconfig -vNX $(echo $LD_LIBRARY_PATH | sed 's/:/ /g') 2>/dev/null |
    awk -v p=$1 'match($1, ":")                    { header=substr($1, 1, length($1)-1)} \
                 match($1, "^lib") && match($1, p) { print header "/" $1}'
}

whichlib64_head() {
    # This function return only the first lib found
    # This avoid a broken pipe error when the old pattern `whichlib64 $foo | head - n1` was used
    for lib in $(whichlib $1)
    do
        if objdump -a $lib | grep 64 > /dev/null; then
            echo $lib
            break
        fi
    done
}

# > unset FOO ; thapi_export FOO 1 ; echo $FOO
# 1
# > export FOO=2 ; thapi_export FOO 1 ; echo $FOO
# 2
# > export FOO=0 ; thapi_export FOO 1 ; echo $FOO
#
thapi_export() {
    if [ -z "${!1}" ]; then
        export "$1"="$2"
    elif [ "${!1}" = "0" ]; then
        unset "$1"
    fi
}

get_mpi_rank() {
    # Get the RankID from different launcher
    if [[ -v MPI_RANKID ]]; then
        echo $MPI_RANKID
    elif [[ -v PALS_RANKID ]]; then
        echo $PALS_RANKID
    else
        echo -1
    fi
}

bt2_all() {
    # Note that the $@ are not quoted!
    if [ -n "$trace" ]; then
        $bindir/babeltrace_thapi --backend <%= languages %> -r -c $@
    fi

    if [ -n "$timeline" ]; then
        $bindir/babeltrace_thapi timeline --backend <%= languages %> $@
    fi

    if [ -z "$timeline" ] && [ -z "$trace" ]; then
        $bindir/babeltrace_thapi tally --backend <%= languages %> $bt_tally_argv -- $@
    fi
}
trace_and_summary() {
    if [ "$#" -eq 0 ]; then
        display_help
    fi
    MPI_RANK=$(get_mpi_rank)

    THAPI_OUTPUT=${LTTNG_HOME:-$HOME}
    mkdir -p $THAPI_OUTPUT

    IFS=","
    if [[ "${traced_ranks}" == "-1" ]] || [[ "${IFS}${traced_ranks}${IFS}" =~ "${IFS}${MPI_RANK}${IFS}" ]]; then
        THAPI_OUTPUT_TMP=${LTTNG_HOME:-$HOME}/lttng-traces/running_trace
        mkdir -p $THAPI_OUTPUT_TMP
        # Need to change LLTNG HOME so each rank have their own "lock"
        THAPI_LOCK_DIR=$HOME/.lttng_mpi/
        mkdir -p $THAPI_LOCK_DIR/$MPI_RANK
        export LTTNG_HOME=$THAPI_LOCK_DIR/$MPI_RANK
    fi
    unset IFS

    lttng-sessiond $quiet --daemonize
<% if ["omp","ze","cuda","cl","hip"].all? { |l| languages.include?(l) } %>
    THAPI_LTTNG_O=${THAPI_OUTPUT}/lttng-traces/iprof-$(date '+%Y%m%d-%H%M%S')
<% elsif languages.include?("cl") %>
    THAPI_LTTNG_O=${THAPI_OUTPUT}/lttng-traces/thapi-opencl-session-$(date '+%Y%m%d-%H%M%S')
<% elsif languages.include?("ze") %>
    THAPI_LTTNG_O=${THAPI_OUTPUT}/lttng-traces/thapi-ze-session-$(date '+%Y%m%d-%H%M%S')
<% elsif languages.include?("cuda") %>
    THAPI_LTTNG_O=${THAPI_OUTPUT}/lttng-traces/thapi-cuda-session-$(date '+%Y%m%d-%H%M%S')
<% elsif languages.include?("hip") %>
    THAPI_LTTNG_O=${THAPI_OUTPUT}/lttng-traces/thapi-hip-session-$(date '+%Y%m%d-%H%M%S')
<% end %>
    if [ $MPI_RANK = -1 ]; then
        lttng $quiet create THAPI -o $THAPI_LTTNG_O
    else
        lttng $quiet create THAPI_$MPI_RANK -o $THAPI_OUTPUT_TMP/$MPI_RANK
    fi

    lttng $quiet enable-channel --userspace --blocking-timeout=inf blocking-channel
<% if languages.include?("omp") %>
    thapi_export LTTNG_UST_OMP_INTEL 1
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ompt:*target*
<% end %>
<% if languages.include?("cl") %>
    opencl_disable_events="lttng_ust_opencl:clSetKernelArg*,lttng_ust_opencl:clGetKernelArg*,"
    opencl_disable_events+="lttng_ust_opencl:clSetKernelExecInfo*,lttng_ust_opencl:clGetKernelInfo*,"
    opencl_disable_events+="lttng_ust_opencl:clGetMemAllocInfoINTEL*"

    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl:* -x ${opencl_disable_events}
    if [ $mode = "full" ]; then
        lttng $quiet enable-event --channel=blocking-channel --userspace ${opencl_disable_events}
    fi
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_build:infos*
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_profiling:*
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_arguments:kernel_info
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_opencl_devices:*
<% end %>
<% if languages.include?("ze") %>

    export LTTNG_UST_ZE_PROFILE=1
    thapi_export LTTNG_UST_ZE_PARANOID_DRIFT 1

    if [ $mode = "minimal" ]; then
        lttng $quiet enable-event --channel=blocking-channel --userspace $(cat $datadir/babeltrace_zeprofiling_apis.txt)
        lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ze_properties:device_timer
    else
        lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ze_build:log*
        lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ze_profiling:*

        ze_disable_properties="lttng_ust_ze_properties:memory_info_properties,lttng_ust_ze_properties:memory_info_range"
        ze_disable_events="lttng_ust_ze:zeKernelSetArgumentValue*,lttng_ust_ze:ze*Get*Properties*,lttng_ust_ze:zeKernelGetName"
        ze_disable_querry="lttng_ust_ze:*QueryStatus"
        lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ze_properties:* -x ${ze_disable_properties}
        lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_ze:* -x ${ze_disable_events},${ze_disable_querry}

        if [ $mode = "full" ]; then
            lttng $quiet enable-event --channel=blocking-channel --userspace ${ze_disable_events}
            lttng $quiet enable-event --channel=blocking-channel --userspace ${ze_disable_properties}
            lttng $quiet enable-event --channel=blocking-channel --userspace ${ze_disable_querry}
        fi
    fi
<% end %>
<% if languages.include?("cuda") %>
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_cuda:*
    export LTTNG_UST_CUDA_PROFILE=1
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_cuda_profiling:*
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_cuda_properties:*
<% end %>
<% if languages.include?("hip") %>
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_hip:*
<% end %>
    # Add thapi metadata
    lttng $quiet enable-event --channel=blocking-channel --userspace lttng_ust_thapi:*

    #Add vpid/vtid to avoid race condition
    lttng $quiet add-context --userspace --channel=blocking-channel -t vpid -t vtid

    #Preventing trace event record loss
    export LTTNG_UST_ALLOW_BLOCKING=1

    #Find libs and preload
<% if languages.include?("omp") %>
    if [ -z "$OMP_TOOL_LIBRARIES" ]; then
        export OMP_TOOL_LIBRARIES=$libdir/libTracerOMPT.so
    fi
<% end %>
<% if languages.include?("cl") %>
<%= print_loader_logic("cl","libOpenCL","libTracerOpenCL")%>
<% end %>
<% if languages.include?("ze") %>
<%= print_loader_logic("ze","libze_loader","libTracerZE")%>
<% end %>
<% if languages.include?("cuda") %>
<%= print_loader_logic("cuda","libcuda","libTracerCUDA")%>
<% end %>
<% if languages.include?("hip") %>
<%= print_loader_logic("hip","libamdhip64","libTracerHIP")%>
<% end %>
    if [ $MPI_RANK = -1 ]; then
        lttng $quiet start THAPI
    else
        lttng $quiet start THAPI_$MPI_RANK
    fi
    #Create the metadata.
    #read and dump `$LTTNG_UST_THAPI_METADATA` env
    $bindir/thapi_metadata
    # Run the binary
    trap 'trace_epilogue' EXIT SIGABRT SIGSEGV
    "$@"
}

trace_epilogue() {
    if [ $MPI_RANK = -1 ]; then
        lttng $quiet stop THAPI
        lttng $quiet destroy THAPI
	summary
	return
    fi

    lttng $quiet stop THAPI_$MPI_RANK
    lttng $quiet destroy THAPI_$MPI_RANK

    # One Rank should be the master rank
    if [[ "${traced_ranks}" == "-1" ]]; then
       master_rank=0
    else
       IFS=","
       #Transform in array, and then take the first element implicitly
       master_rank=($traced_ranks)
       unset IFS
    fi
    # The master rank "wait" and then print the summary
    if [[ ${MPI_RANK} == ${master_rank} ]]; then
        while [ $(find $THAPI_LOCK_DIR/* -maxdepth 1 -type f -name .lttngrc | wc -l) != 0 ]; do
            sleep 1
        done
        mv ${THAPI_OUTPUT_TMP} $THAPI_LTTNG_O
        summary
    fi
}


summary() {
    if [ -n "$THAPI_LTTNG_O" ]; then
        lttng_last_session=$THAPI_LTTNG_O
        >&2 echo "Trace location:" $lttng_last_session
        >&2 echo
    elif [ "$#" -eq 0 ]; then
        THAPI_OUTPUT=${LTTNG_HOME:-$HOME}
<% if ["omp","ze","cuda","cl", "hip"].all? { |l| languages.include?(l) } %>
        lttng_last_session=$(ls -dt ${THAPI_OUTPUT}/lttng-traces/iprof-* | head -1)
<% elsif languages.include?("cl") %>
        lttng_last_session=$(ls -dt ${THAPI_OUTPUT}/lttng-traces/thapi-opencl-session* | head -1)
<% elsif languages.include?("ze") %>
        lttng_last_session=$(ls -dt ${THAPI_OUTPUT}/lttng-traces/thapi-ze-session* | head -1)
<% elsif languages.include?("cuda") %>
        lttng_last_session=$(ls -dt ${THAPI_OUTPUT}/lttng-traces/thapi-cuda-session* | head -1)
<% elsif languages.include?("hip") %>
        lttng_last_session=$(ls -dt ${THAPI_OUTPUT}/lttng-traces/thapi-hip-session* | head -1)
<% end %>
        >&2 echo "Trace location:" $lttng_last_session
        >&2 echo
    else
        lttng_last_session=$@
    fi
    # Check that the argument are trace.
    # We don't quote the $lttng_last_session, to be able to loop over hit.
    # Should be cleaner to use bash arrays.
    for f in  $lttng_last_session; do
        if [ ! -d "$f" ]; then
            echo "$f is not a trace folder, cannot replay. Exiting..."
            exit 1
        fi
    done
    bt2_all "${lttng_last_session}"
}

#  _
# |_) _. ._ _ o ._   _     /\  ._ _
# |  (_| | _> | | | (_|   /--\ | (_| \/
#                    _|           _|
mode=default

if [ "$#" -eq 0 ]; then
    display_help
fi

bt_tally_argv=""
traced_ranks=0
while (( "$#" )); do
    case "$1" in
        -h | --help)            display_help; exit ;;
        -v | --version)         display_version; exit ;;
        -k | --kernel-verbose)  shift; bt_tally_argv+=" --display_kernel_verbose=true" ;;
        -e | --extented)        shift; bt_tally_argv+=" --display=extended" ;;
        -r | --replay)          shift; replay=true ;;
        -t | --trace)           shift; trace=true ;;
        -l | --timeline)        shift; timeline=true ;;
        -j | --json)            shift; bt_tally_argv+=" --display_mode=json" ;;
        -m | --mode)            shift; mode=$1; shift ;;
	--traced-ranks)		shift; traced_ranks=$1; shift ;;
	--asm)                  shift; asm=true ;;
        --metadata)             shift; bt_tally_argv+=" --display_metadata=true" ;;
        --max-name-size)        shift; bt_tally_argv+=" --display_name_max_size=$1"; shift ;;
        --mangle)               shift; bt_tally_argv+=" --mangling=mangle" ;;
        --debug)                shift; debug=true ;;
        --)                     shift; break ;;
        *)                      break  ;;
    esac
done

if [ -n "$debug" ]; then
    set -x
<% if languages.include?("ze") %>
    export LTTNG_UST_ZE_VERBOSE=1
<% end %>
<% if languages.include?("cl") %>
    export LTTNG_UST_OPENCL_VERBOSE=1
<% end %>
<% if languages.include?("cuda") %>
    export LTTNG_UST_CUDA_VERBOSE=1
<% end %>
<% if languages.include?("hip") %>
    export LTTNG_UST_HIP_VERBOSE=1
<% end %>
<% if languages.include?("omp") %>
    export LTTNG_UST_OMP_VERBOSE=1
<% end %>
    export LTTNG_UST_DEBUG=y
    export LIBBABELTRACE2_INIT_LOG_LEVEL=WARNING
    export BABELTRACE_CLI_LOG_LEVEL=WARNING
else
    quiet="--quiet"
fi

if [ -n "$asm" ]; then
    export SYCL_CACHE_PERSISTENT=0
    #This is a workarround for the fact that `SYCL_CACHE_PERSISTENT` doesn't work yet.
    rm -rf "$USER"/libsycl_cache/.cache/

    export IGC_ShaderDumpEnable=1
    export IGC_DumpToCurrentDir=1
fi

if [ -n "$replay" ]; then
    summary "$@"
else
    trace_and_summary "$@"
fi
